# Reproducer for mitmproxy discussion 6769

https://github.com/mitmproxy/mitmproxy/discussions/6769

## Problem

`Validity` of certificates generated by mitmproxy depends on the way mitmproxy accesses upstream server.

## Steps to reproduce

- `./setup.sh`
    - adds mapping `127.0.0.1	example.test` to /etc/hosts
    - generates root CA certificate
- `docker compose up -d`
    - spins up nginx and mitm
- `openssl s_client -connect example.test:443 -showcerts </dev/null 2>/dev/null | openssl x509 -outform PEM > /tmp/cert.pem && openssl verify -CAfile ./ca/ca.pem /tmp/cert.pem`
    - OK:
      ```
      Warning: Reading certificate from stdin since no -in or -new option is given
      /tmp/cert.pem: OK
      ```
- replace `reverse:https://example.dev:443@443` with `reverse:https://example.test:443@443`
  in `docker-compose.yml`
- `docker compose down && docker compose up -d`
- `openssl s_client -connect example.test:443 -showcerts </dev/null 2>/dev/null | openssl x509 -outform PEM > /tmp/cert.pem && openssl verify -CAfile ./ca/ca.pem /tmp/cert.pem`
    - OK:
      ```
      Warning: Reading certificate from stdin since no -in or -new option is given
      /tmp/cert.pem: OK
      ```
- replace `reverse:https://example.test:443@443` with `reverse:https://nginx:443@443`
  in `docker-compose.yml`
- `docker compose down && docker compose up -d`
- `openssl s_client -connect example.test:443 -showcerts </dev/null 2>/dev/null | openssl x509 -outform PEM > /tmp/cert.pem && openssl verify -CAfile ./ca/ca.pem /tmp/cert.pem`
    - NOK:
      ```
      Warning: Reading certificate from stdin since no -in or -new option is given
      CN=.test
      error 47 at 0 depth lookup: permitted subtree violation
      error /tmp/cert.pem: verification failed
      ```
- cleanup: remove mappings from /etc/hosts!
